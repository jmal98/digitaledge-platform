/*
 *                                  Apache License
 *                            Version 2.0, January 2004
 *                         http://www.apache.org/licenses/
 *
 *    TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
 *
 *    1. Definitions.
 *
 *       "License" shall mean the terms and conditions for use, reproduction,
 *       and distribution as defined by Sections 1 through 9 of this document.
 *
 *       "Licensor" shall mean the copyright owner or entity authorized by
 *       the copyright owner that is granting the License.
 *
 *       "Legal Entity" shall mean the union of the acting entity and all
 *       other entities that control, are controlled by, or are under common
 *       control with that entity. For the purposes of this definition,
 *       "control" means (i) the power, direct or indirect, to cause the
 *       direction or management of such entity, whether by contract or
 *       otherwise, or (ii) ownership of fifty percent (50%) or more of the
 *       outstanding shares, or (iii) beneficial ownership of such entity.
 *
 *       "You" (or "Your") shall mean an individual or Legal Entity
 *       exercising permissions granted by this License.
 *
 *       "Source" form shall mean the preferred form for making modifications,
 *       including but not limited to software source code, documentation
 *       source, and configuration files.
 *
 *       "Object" form shall mean any form resulting from mechanical
 *       transformation or translation of a Source form, including but
 *       not limited to compiled object code, generated documentation,
 *       and conversions to other media types.
 *
 *       "Work" shall mean the work of authorship, whether in Source or
 *       Object form, made available under the License, as indicated by a
 *       copyright notice that is included in or attached to the work
 *       (an example is provided in the Appendix below).
 *
 *       "Derivative Works" shall mean any work, whether in Source or Object
 *       form, that is based on (or derived from) the Work and for which the
 *       editorial revisions, annotations, elaborations, or other modifications
 *       represent, as a whole, an original work of authorship. For the purposes
 *       of this License, Derivative Works shall not include works that remain
 *       separable from, or merely link (or bind by name) to the interfaces of,
 *       the Work and Derivative Works thereof.
 *
 *       "Contribution" shall mean any work of authorship, including
 *       the original version of the Work and any modifications or additions
 *       to that Work or Derivative Works thereof, that is intentionally
 *       submitted to Licensor for inclusion in the Work by the copyright owner
 *       or by an individual or Legal Entity authorized to submit on behalf of
 *       the copyright owner. For the purposes of this definition, "submitted"
 *       means any form of electronic, verbal, or written communication sent
 *       to the Licensor or its representatives, including but not limited to
 *       communication on electronic mailing lists, source code control systems,
 *       and issue tracking systems that are managed by, or on behalf of, the
 *       Licensor for the purpose of discussing and improving the Work, but
 *       excluding communication that is conspicuously marked or otherwise
 *       designated in writing by the copyright owner as "Not a Contribution."
 *
 *       "Contributor" shall mean Licensor and any individual or Legal Entity
 *       on behalf of whom a Contribution has been received by Licensor and
 *       subsequently incorporated within the Work.
 *
 *    2. Grant of Copyright License. Subject to the terms and conditions of
 *       this License, each Contributor hereby grants to You a perpetual,
 *       worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *       copyright license to reproduce, prepare Derivative Works of,
 *       publicly display, publicly perform, sublicense, and distribute the
 *       Work and such Derivative Works in Source or Object form.
 *
 *    3. Grant of Patent License. Subject to the terms and conditions of
 *       this License, each Contributor hereby grants to You a perpetual,
 *       worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 *       (except as stated in this section) patent license to make, have made,
 *       use, offer to sell, sell, import, and otherwise transfer the Work,
 *       where such license applies only to those patent claims licensable
 *       by such Contributor that are necessarily infringed by their
 *       Contribution(s) alone or by combination of their Contribution(s)
 *       with the Work to which such Contribution(s) was submitted. If You
 *       institute patent litigation against any entity (including a
 *       cross-claim or counterclaim in a lawsuit) alleging that the Work
 *       or a Contribution incorporated within the Work constitutes direct
 *       or contributory patent infringement, then any patent licenses
 *       granted to You under this License for that Work shall terminate
 *       as of the date such litigation is filed.
 *
 *    4. Redistribution. You may reproduce and distribute copies of the
 *       Work or Derivative Works thereof in any medium, with or without
 *       modifications, and in Source or Object form, provided that You
 *       meet the following conditions:
 *
 *       (a) You must give any other recipients of the Work or
 *           Derivative Works a copy of this License; and
 *
 *       (b) You must cause any modified files to carry prominent notices
 *           stating that You changed the files; and
 *
 *       (c) You must retain, in the Source form of any Derivative Works
 *           that You distribute, all copyright, patent, trademark, and
 *           attribution notices from the Source form of the Work,
 *           excluding those notices that do not pertain to any part of
 *           the Derivative Works; and
 *
 *       (d) If the Work includes a "NOTICE" text file as part of its
 *           distribution, then any Derivative Works that You distribute must
 *           include a readable copy of the attribution notices contained
 *           within such NOTICE file, excluding those notices that do not
 *           pertain to any part of the Derivative Works, in at least one
 *           of the following places: within a NOTICE text file distributed
 *           as part of the Derivative Works; within the Source form or
 *           documentation, if provided along with the Derivative Works; or,
 *           within a display generated by the Derivative Works, if and
 *           wherever such third-party notices normally appear. The contents
 *           of the NOTICE file are for informational purposes only and
 *           do not modify the License. You may add Your own attribution
 *           notices within Derivative Works that You distribute, alongside
 *           or as an addendum to the NOTICE text from the Work, provided
 *           that such additional attribution notices cannot be construed
 *           as modifying the License.
 *
 *       You may add Your own copyright statement to Your modifications and
 *       may provide additional or different license terms and conditions
 *       for use, reproduction, or distribution of Your modifications, or
 *       for any such Derivative Works as a whole, provided Your use,
 *       reproduction, and distribution of the Work otherwise complies with
 *       the conditions stated in this License.
 *
 *    5. Submission of Contributions. Unless You explicitly state otherwise,
 *       any Contribution intentionally submitted for inclusion in the Work
 *       by You to the Licensor shall be under the terms and conditions of
 *       this License, without any additional terms or conditions.
 *       Notwithstanding the above, nothing herein shall supersede or modify
 *       the terms of any separate license agreement you may have executed
 *       with Licensor regarding such Contributions.
 *
 *    6. Trademarks. This License does not grant permission to use the trade
 *       names, trademarks, service marks, or product names of the Licensor,
 *       except as required for reasonable and customary use in describing the
 *       origin of the Work and reproducing the content of the NOTICE file.
 *
 *    7. Disclaimer of Warranty. Unless required by applicable law or
 *       agreed to in writing, Licensor provides the Work (and each
 *       Contributor provides its Contributions) on an "AS IS" BASIS,
 *       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 *       implied, including, without limitation, any warranties or conditions
 *       of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
 *       PARTICULAR PURPOSE. You are solely responsible for determining the
 *       appropriateness of using or redistributing the Work and assume any
 *       risks associated with Your exercise of permissions under this License.
 *
 *    8. Limitation of Liability. In no event and under no legal theory,
 *       whether in tort (including negligence), contract, or otherwise,
 *       unless required by applicable law (such as deliberate and grossly
 *       negligent acts) or agreed to in writing, shall any Contributor be
 *       liable to You for damages, including any direct, indirect, special,
 *       incidental, or consequential damages of any character arising as a
 *       result of this License or out of the use or inability to use the
 *       Work (including but not limited to damages for loss of goodwill,
 *       work stoppage, computer failure or malfunction, or any and all
 *       other commercial damages or losses), even if such Contributor
 *       has been advised of the possibility of such damages.
 *
 *    9. Accepting Warranty or Additional Liability. While redistributing
 *       the Work or Derivative Works thereof, You may choose to offer,
 *       and charge a fee for, acceptance of support, warranty, indemnity,
 *       or other liability obligations and/or rights consistent with this
 *       License. However, in accepting such obligations, You may act only
 *       on Your own behalf and on Your sole responsibility, not on behalf
 *       of any other Contributor, and only if You agree to indemnify,
 *       defend, and hold each Contributor harmless for any liability
 *       incurred by, or claims asserted against, such Contributor by reason
 *       of your accepting any such warranty or additional liability.
 *
 *    END OF TERMS AND CONDITIONS
 *
 *    APPENDIX: How to apply the Apache License to your work.
 *
 *       To apply the Apache License to your work, attach the following
 *       boilerplate notice, with the fields enclosed by brackets "{}"
 *       replaced with your own identifying information. (Don't include
 *       the brackets!)  The text should be enclosed in the appropriate
 *       comment syntax for the file format. We also recommend that a
 *       file or class name and description of purpose be included on the
 *       same "printed page" as the copyright notice for easier
 *       identification within third-party archives.
 *
 *    Copyright {yyyy} {name of copyright owner}
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
var SystemUsages = {};
var SelectedSystems = {};
var DataSinkChart = null;
var DataFormatsChart = null;
var CostBarChart = null;
var IngestChart = null;
var alertsDropdown = "#alertsDropdown";

$(document).ready(function() {
	requestSystemList(handleSystemListResponse);
	requestActiveSystemList(handleActiveSystemListResponse);
	getUnseenAlerts(handleUnseenAlertsResponse);
});

/* { systems : ["system name"] } */
var handleSystemListResponse = function(json) {
	var systems = json['systems'];
	for ( var index in systems) {
		var systemName = systems[index];
		if (!SystemUsages[systemName]) {
			SystemUsages[systemName] = {};
			SystemUsages[systemName]['systemEvents'] = {};
			SystemUsages[systemName]['active'] = false;
		}
	}
	loadSystemSelectionList();
};

/* { systems : ["system name"] } */
var handleActiveSystemListResponse = function(json) {
	for ( var sys in SystemUsages) {
		SystemUsages[sys]['active'] = false;
	}
	var systems = json['systems'];
	for ( var index in systems) {
		var systemName = systems[index];
		if (!SystemUsages[systemName]) {
			SystemUsages[systemName] = {};
			SystemUsages[systemName]['systemEvents'] = {};
		}
		SystemUsages[systemName]['active'] = true;
	}
	loadSystemSelectionList();
};

/*
 * { systemName : "name", systemEvents : {time-unix : {user : "name of user",
 * eventType : "event" } }
 */

var handleSystemEventsResponse = function(json) {
	var systemName = json['systemName'];
	if (!SystemUsages[systemName]) {
		SystemUsages[systemName] = {};
		SystemUsages[systemName]['systemEvents'] = {};
	}
	for ( var key in json['systemEvents']) {
		SystemUsages[systemName]['systemEvents'][key] = json['systemEvents'][key];
	}
	if (updateEventLogTable)
		updateEventLogTable();
};

/*
 * {unseenAlerts: {"alertName" : "triggeredTime"} }
 */
var handleUnseenAlertsResponse = function(json) {
	var alertText = "<button type='button' class='close' data-dismiss='alert' id='closeAlertsText' aria-hidden='true'>&times;</button> <div id='alertText'> <strong> Alerts Notification:</strong>";
	var dropdownAlerts = "";
	var numAlerts = 0;
	var alertsToDismiss = [];
	for ( var alertName in json['unseenAlerts']) {
		alertsToDismiss.push(alertName);
		numAlerts++;
		dropdownAlerts += "<li><a href='#'><div><i class='fa fa-exclamation-circle fa-fw'></i>&nbsp;"
				+ alertName
				+ "<span class='pull-right text-muted small'>"
				+ new Date(json['unseenAlerts'][alertName] * 1)
						.toLocaleString()
				+ "</span></div></a></li><li class='divider'></li>";
		alertText += "<br/>Alert '"
				+ alertName
				+ "' was triggered at "
				+ new Date(json['unseenAlerts'][alertName] * 1)
						.toLocaleString();
	}
	console.log(json['unseenAlerts'].length);
	if (numAlerts == 0) {
		dropdownAlerts = "<li><a class='text-center' href='alert-settings.html'><strong>Create Alerts</strong> <i class='fa fa-angle-right'></i></a></li>";
	} else {
		dropdownAlerts += "<li><a class='text-center' href='alert-settings.html'><strong>Manage Alerts</strong> <i class='fa fa-angle-right'></i></a></li>";
	}
	alertText += "<br/>To view and manage alerts, go to <a href='alert-settings.html' id='alertSettingsLink' class='alert-link'>Alert Settings</a>";
	alertText += "</div>";
	if (numAlerts != 0) {
		$("#alertTextDiv").addClass("alert");
		$("#alertTextDiv").addClass("alert-danger");
		$("#alertTextDiv").addClass("alert-dismissable");
		$("#alertTextDiv").html(alertText);
	}

	$("#closeAlertsText").click(function() {
		markAlertAsSeen(null, alertsToDismiss);
	});

	$("#alertSettingsLink").click(function() {
		markAlertAsSeen(null, alertsToDismiss);
	});

	$(alertsDropdown).html(dropdownAlerts);
};

/*
 * {costs: {time-unix : {"name of user": cost} }
 */
var handleSystemCostDataResponse = function(json) {
	graphCostBarChart(json);
};

var handleSystemIngestInfoResponse = function(json) {
	createDygraph(json);
};

var handleDataSinkInfoResponse = function(json) {
	createDataSinkChart(json);
};

var handleSystemPerformanceInfoResponse = function(json) {
	createSystemPerformanceChart(json);
};

var handleSystemIngestFormatsResponse = function(json) {
	createSystemIngestFormatsChart(json);
};

var timeIntervals = {
	HOURS : (60 * 60 * 1000),
	DAYS : (24 * 60 * 60 * 1000),
	WEEKS : (7 * 24 * 60 * 60 * 1000),
	MONTHS : (30 * 24 * 60 * 60 * 1000),
	YEARS : (365 * 24 * 60 * 60 * 1000)
};

var barCostDataInterval = timeIntervals['DAYS'];

var ingestChart = "#ingestChartData";
var ingestChartSelection = "#ingestChartDataSelection";
var systemSelectionList = "#systemSelectionRow";
var inactiveSystemSelectionList = "#inactiveSystemSelectionRow";
var dataSinksChart = "donut-chart-datasinks";
var formatsChart = "donut-chart-formats";
var systemPerformanceTable = "#systemPerformanceTable";
var systemRuntimeTable = "#systemRuntimeTable";

var dygraphChart = "dygraphIngestChart";

$(document).ready(function() {

	$(systemPerformanceTable).dataTable({
		"data" : [],
		"columns" : [ {
			"title" : "System",
			"class" : "center"
		}, {
			"title" : "# Records",
			"class" : "center"
		}, {
			"title" : "Cost",
			"class" : "center"
		}, {
			"title" : "Records per $",
			"class" : "center"
		}, {
			"title" : "Records per second",
			"class" : "center"
		} ]
	});
	$(systemRuntimeTable).dataTable({
		"data" : [],
		"columns" : [ {
			"title" : "System",
			"class" : "center"
		}, {
			"title" : "Processing Time",
			"class" : "center"
		}, {
			"title" : "Idle Time",
			"class" : "center"
		}, {
			"title" : "Total Uptime",
			"class" : "center"
		}, {
			"title" : "Processing vs Idle",
			"class" : "center"
		} ]
	});
});

/*
 * {"costs" : {<system-name> : val} }
 */
function graphCostBarChart(json) {
	var data = [];
	var dataTicks = [];
	var index = 0;
	for ( var system in json['costs']) {
		var systemName = system.split('.')[0];
		data[index] = [ index, json['costs'][system] ];
		dataTicks[index] = [ index, systemName ];
		index += 1;
	}

	if (data.length == 0)
		return;

	var dataset = [ {
		label : "Estimated System Cost",
		data : data,
		color : "#5482FF"
	} ];

	var options = {
		series : {
			bars : {
				show : true
			}
		},
		bars : {
			align : "center",
			barWidth : 0.5
		},
		xaxis : {
			axisLabel : "Systems",
			axisLabelUseCanvas : true,
			axisLabelFontSizePixels : 12,
			axisLabelFontFamily : "Verdana, Arial",
			axisLabelPadding : 10,
			ticks : dataTicks
		},
		yaxis : {
			axisLabel : "Cost",
			axisLabelUseCanvas : true,
			axisLabelFontSizePixels : 12,
			axisLabelFontFamily : "Verdana, Arial",
			axisLabelPadding : 3,
			tickFormatter : function(v, axis) {
				return "$" + Math.round(v * 100) / 100;
			}
		},
		legend : {
			noColumns : 0,
			labelBoxBorderColor : "#000000",
			position : "nw"
		},
		grid : {
			hoverable : true,
			borderWidth : 2,
			backgroundColor : {
				colors : [ "#ffffff", "#EDF5FF" ]
			}
		}
	};
	if (CostBarChart == null) {
		CostBarChart = $.plot($("#cost-bar-chart"), dataset, options);
		$("#cost-bar-chart").UseTooltip();
	} else {
		CostBarChart = $.plot($("#cost-bar-chart"), dataset, options);
		$("#cost-bar-chart").UseTooltip();
	}
}

var previousPoint = null, previousLabel = null;

$.fn.UseTooltip = function() {
	$(this).bind(
			"plothover",
			function(event, pos, item) {
				if (item) {
					if ((previousLabel != item.series.label)
							|| (previousPoint != item.dataIndex)) {
						previousPoint = item.dataIndex;
						previousLabel = item.series.label;
						$("#tooltip").remove();

						var x = item.datapoint[0];
						var y = item.datapoint[1];

						var color = item.series.color;

						// console.log(item.series.xaxis.ticks[x].label);

						showTooltip(item.pageX, item.pageY, color, "<strong>"
								+ item.series.label + "</strong><br>"
								+ item.series.xaxis.ticks[x].label
								+ " : <strong>$" + y + "</strong>");
					}
				} else {
					$("#tooltip").remove();
					previousPoint = null;
				}
			});
};

function showTooltip(x, y, color, contents) {
	$('<div id="tooltip">' + contents + '</div>').css({
		position : 'absolute',
		display : 'none',
		top : y - 40,
		left : x - 120,
		border : '2px solid ' + color,
		padding : '3px',
		'font-size' : '9px',
		'border-radius' : '5px',
		'background-color' : '#fff',
		'font-family' : 'Verdana, Arial, Helvetica, Tahoma, sans-serif',
		opacity : 0.9
	}).appendTo("body").fadeIn(200);
}

/*
 * { "ingestInfo": { "<systemName>" : {"<ingestTime>" : "<ingestAmt>"} } }
 */
function createDygraph(json) {
	var data = [];
	var dataKeys = {};
	var labels = [ "Time" ];
	var times = [];
	for ( var systemName in json['ingestInfo']) {
		labels.push(systemName.split(".")[0]);
		for ( var key in json['ingestInfo'][systemName]) {
			if (times.indexOf(key) == -1)
				times.push(key);
		}
	}

	times.sort();

	for ( var i in times) {
		dataKeys[times[i]] = [];
		dataKeys[times[i]].push(new Date(times[i] * 1));
		for ( var systemName in json['ingestInfo']) {
			if (json['ingestInfo'][systemName][times[i]]
					|| json['ingestInfo'][systemName][times[i]] == 0) {
				dataKeys[times[i]]
						.push(json['ingestInfo'][systemName][times[i]]);
			} else {
				dataKeys[times[i]].push(null);
			}
		}
	}

	for ( var key in dataKeys)
		data.push(dataKeys[key]);

	var options = {
		labels : labels,
		legend : 'always',
		title : 'Systems Ingest Info',
		highlightSeriesOpts : {
			strokeWidth : 3,
			strokeBorderWidth : 1,
			highlightCircleSize : 5,
		},
		valueRange : [ 0, null ],
		drawPoints : true,
		connectSeparatedPoints : true,
		showRangeSelector : true
	};
	IngestChart = new Dygraph(document.getElementById(dygraphChart), data,
			options);
	var onclick = function(ev) {
		if (IngestChart.isSeriesLocked()) {
			IngestChart.clearSelection();
		} else {
			IngestChart.setSelection(IngestChart.getSelection(), IngestChart
					.getHighlightSeries(), true);
		}
	};
	IngestChart.updateOptions({
		clickCallback : onclick
	}, true);

}

/*
 * {"dataSinkInfo" : {<datasink-name>:<amount>} }
 */
function createDataSinkChart(json) {
	var dataPts = [];

	for ( var dataSink in json['dataSinkInfo']) {
		var data = {};
		data['label'] = dataSink;
		data['value'] = json['dataSinkInfo'][dataSink];
		dataPts.push(data);
	}

	if (DataSinkChart == null) {
		if (dataPts.length != 0) {
			DataSinkChart = Morris.Donut({
				element : dataSinksChart,
				data : dataPts,
				resize : true
			});
		}
	} else {
		DataSinkChart.setData(dataPts);
	}
}

/*
 * { "systemPerformances" : {<system> : {"recordsIngested":val, "cost":val,
 * "runningRatio":val, "runningHours":val, "costRatio:val", "idleHours":val,
 * "totalHours":val, "recordsPerSeconds":val} } }
 */
function createSystemPerformanceChart(json) {
	$(systemPerformanceTable).DataTable().clear();
	$(systemRuntimeTable).DataTable().clear();
	for ( var system in json['systemPerformances']) {
		var dataA = [];
		dataA[0] = system.split(".")[0];
		dataA[1] = json['systemPerformances'][system]['recordsIngested'];
		dataA[2] = "$" + json['systemPerformances'][system]['cost'];
		dataA[3] = json['systemPerformances'][system]['costRatio'];
		dataA[4] = json['systemPerformances'][system]['recordsPerSecond'];
		$(systemPerformanceTable).DataTable().row.add(dataA);
		var dataB = [];
		dataB[0] = system.split(".")[0];
		dataB[1] = json['systemPerformances'][system]['runningHours']
				+ " hours";
		dataB[2] = json['systemPerformances'][system]['idleHours'] + " hours";
		dataB[3] = json['systemPerformances'][system]['totalHours'] + " hours";
		dataB[4] = json['systemPerformances'][system]['runningRatio'] + "%";
		$(systemRuntimeTable).DataTable().row.add(dataB);
	}
	$(systemPerformanceTable).DataTable().draw();
	$(systemRuntimeTable).DataTable().draw();
}

function systemSelectionChanged() {
	requestSystemIngestInfo(handleSystemIngestInfoResponse,
			getSelectedSystems(), (new Date).getTime() - timeIntervals["WEEKS"]);
	requestDataSinkInfo(handleDataSinkInfoResponse, getSelectedSystems());
	requestSystemPerformanceInfo(handleSystemPerformanceInfoResponse,
			getSelectedSystems());
	requestSystemCostData(handleSystemCostDataResponse, getSelectedSystems());
	requestSystemIngestFormats(handleSystemIngestFormatsResponse,
			getSelectedSystems());
}

/*
 * { "formatsData" : {<format> : val} }
 */
function createSystemIngestFormatsChart(json) {
	var dataPts = [];

	for ( var format in json['formatsData']) {
		var data = {};
		data['label'] = format;
		data['value'] = json['formatsData'][format];
		dataPts.push(data);
	}

	if (DataFormatsChart == null) {
		if (dataPts.length != 0) {
			DataFormatsChart = Morris.Donut({
				element : formatsChart,
				data : dataPts,
				resize : true
			});
		}
	} else {
		DataFormatsChart.setData(dataPts);
	}
}

function loadSystemSelectionList() {
	var activeSystems = 0;
	var inactiveSystems = 0;
	var systemNameArr = [];
	for ( var systemName in SystemUsages) {
		systemNameArr.push(systemName);
		if (SystemUsages[systemName]['active']) {
			activeSystems++;
		} else {
			inactiveSystems++;
		}
	}

	systemNameArr.sort();

	var activeCode = null;
	if (activeSystems == 1)
		activeCode = "<strong>1 Active System:</strong><br/>";
	else
		activeCode = "<strong>" + activeSystems
				+ " Active Systems:</strong><br/>";

	var selectAllActive = "<div class=\"col-md-3\" name='activeSystemAll' >";
	selectAllActive += "<div class='systemTextLabel'><strong>Select All</strong></div>";
	selectAllActive += "<div class='slideTwo'> <input type='checkbox' value='None' class='slideTwoLabel' ";
	selectAllActive += "id='selectAllActive' /> <label for='slideTwo'></label></div></div>";
	activeCode += selectAllActive;

	var inactiveCode = null;
	if (inactiveSystems == 1)
		inactiveCode = "<strong>1 Inactive System:</strong><br/>";
	else
		inactiveCode = "<strong>" + inactiveSystems
				+ " Inactive Systems:</strong><br/>";

	var selectAllInactive = "<div class=\"col-md-3\" name='inactiveSystemAll'";
	selectAllInactive += "> <div class='systemTextLabel'><strong>Select All</strong></div>";
	selectAllInactive += "<div class='slideTwo'> <input type='checkbox' value='None' class='slideTwoLabel'";
	selectAllInactive += "id='selectAllInactive' /> <label for='slideTwo'></label></div></div>";
	inactiveCode += selectAllInactive;

	for ( var index in systemNameArr) {
		if (SystemUsages[systemNameArr[index]]['active']) {
			var system = systemNameArr[index].split(".")[0];
			activeCode += "<div class=\"col-md-3\" name='activeSystem' onclick=\"$('#"
					+ system;
			activeCode += "Slider').click(); \"> <div class='systemTextLabel'><strong>"
					+ system + "</strong></div>";
			activeCode += "<div class='slideTwo'> <input type='checkbox' value='None' data-state='active' class='slideTwoLabel'";
			activeCode += "id='" + system + "Slider' name='"
					+ systemNameArr[index]
					+ "' /> <label for='slideTwo'></label></div></div>";
		} else {
			var system = systemNameArr[index].split(".")[0];
			inactiveCode += "<div class=\"col-md-3\" name='inactiveSystem' onclick=\"$('#"
					+ system;
			inactiveCode += "Slider').click(); \"> <div class='systemTextLabel'><strong>"
					+ system + "</strong></div>";
			inactiveCode += "<div class='slideTwo'> <input type='checkbox' value='None' data-state='inactive' class='slideTwoLabel'";
			inactiveCode += "id='" + system + "Slider' name='"
					+ systemNameArr[index]
					+ "' /> <label for='slideTwo'></label></div></div>";
		}
	}

	var selectAllCaused = false;
	$(systemSelectionList).html(activeCode);
	$(inactiveSystemSelectionList).html(inactiveCode);
	$(".slideTwoLabel").click(function(e) {
		if ($(this).is(':checked') && $(this).attr("name")) {
			SelectedSystems[$(this).attr("name")] = true;
		} else {
			SelectedSystems[$(this).attr("name")] = false;
		}
		e.stopPropagation();
		if (!selectAllCaused)
			systemSelectionChanged();

	});
	$("div[name='activeSystemAll']").click(function() {
		selectAllCaused = true;
		$("#selectAllActive").click();
		if ($("#selectAllActive").is(':checked')) {
			$(".slideTwoLabel").each(function(i) {
				if ($(this).attr("data-state") == "active") {
					if (!$(this).is(':checked')) {
						$(this).click();
					}
				}
			});
		} else {
			$(".slideTwoLabel").each(function(i) {
				if ($(this).attr("data-state") == "active") {
					if ($(this).is(':checked')) {
						$(this).click();
					}
				}
			});
		}
		selectAllCaused = false;
		systemSelectionChanged();
	});
	$("div[name='inactiveSystemAll']").click(function() {
		selectAllCaused = true;
		$("#selectAllInactive").click();
		if ($("#selectAllInactive").is(':checked')) {
			$(".slideTwoLabel").each(function(i) {
				if ($(this).attr("data-state") == "inactive") {
					if (!$(this).is(':checked')) {
						$(this).click();
					}
				}
			});
		} else {
			$(".slideTwoLabel").each(function(i) {
				if ($(this).attr("data-state") == "inactive") {
					if ($(this).is(':checked')) {
						$(this).click();
					}
				}
			});
		}
		selectAllCaused = false;
		systemSelectionChanged();
	});
	$("div[name='activeSystemAll']").click();
}

function getSelectedSystems() {
	var systemNames = [];
	for ( var systemName in SelectedSystems) {
		if (SelectedSystems[systemName])
			systemNames.push(systemName);
	}
	return systemNames;
}